import discord
from discord import app_commands
from discord.ext import commands
import json
from pytube import YouTube
from pytube.exceptions import VideoUnavailable
import yt_dlp  # æ›¿ä»£ pytube çš„ä¸‹è¼‰å·¥å…·
import os


from core.cogs import Cog_Extention

with open('setting.json', mode="r", encoding='utf8') as jfile:
    jdata = json.load(jfile)

class music(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        
        self.playing_list = {}  # ä½¿ç”¨å­—å…¸ä¾†ç®¡ç†æ¯å€‹ä¼ºæœå™¨çš„æ’­æ”¾æ¸…å–®

    def get_playing_list(self, guild_id):
        """å–å¾—ä¼ºæœå™¨çš„æ’­æ”¾æ¸…å–®"""
        if guild_id not in self.playing_list:
            self.playing_list[guild_id] = []
        return self.playing_list[guild_id]

    @app_commands.command(name="join", description="è®“æ©Ÿå™¨äººåŠ å…¥èªéŸ³é »é“")
    async def join(self, interaction: discord.Interaction):
        print("join æŒ‡ä»¤è¢«è§¸ç™¼")  # é™¤éŒ¯è¨Šæ¯
        if not interaction.user.voice or not interaction.user.voice.channel:
            await interaction.response.send_message("âš  ä½ éœ€è¦å…ˆåŠ å…¥èªéŸ³é »é“ï¼", ephemeral=True)
            return

        channel = interaction.user.voice.channel
        await channel.connect()
        await interaction.response.send_message(f"âœ… å·²åŠ å…¥èªéŸ³é »é“ï¼š{channel.name}")

    @app_commands.command(name="music", description="æ’­æ”¾éŸ³æ¨‚")
    async def music(self, interaction: discord.Interaction, url: str):
        await interaction.response.send_message("âœ… å·²åŠ å…¥æ’­æ”¾æ¸…å–®ã€‚", ephemeral=True)
        await interaction.channel.send(f"```å·²åŠ å…¥æ’­æ”¾æ¸…å–®â¬‡```")
        await interaction.channel.send(url)
        await self.play(interaction, url)

    async def play(self, interaction: discord.Interaction, url: str = ""):
        playing_list = self.get_playing_list(interaction.guild.id)

        # å–å¾—ç›®å‰æ©Ÿå™¨äººç‹€æ…‹
        voice = discord.utils.get(self.bot.voice_clients, guild=interaction.guild)

        # å¦‚æœæ©Ÿå™¨äººæ­£åœ¨æ’­æ”¾éŸ³æ¨‚, å°‡éŸ³æ¨‚æ”¾å…¥æ’­æ”¾æ¸…å–®
        if voice and voice.is_playing():
            playing_list.append(url)
            await interaction.channel.send("ğŸµ å·²å°‡æ­Œæ›²åŠ å…¥æ’­æ”¾æ¸…å–®ã€‚")
            return

        # åˆªé™¤èˆŠçš„éŸ³æ¨‚æª”æ¡ˆ
        if os.path.isfile("song.mp4"):
            os.remove("song.mp4")

        # å˜—è©¦ä¸‹è¼‰éŸ³æ¨‚
        try:
            await interaction.channel.send("ğŸµ æ­£åœ¨ä¸‹è¼‰éŸ³æ¨‚ï¼Œè«‹ç¨å€™...")
            self.download_audio(url)
        except VideoUnavailable:
            await interaction.channel.send("âŒ ç„¡æ³•ä¸‹è¼‰éŸ³æ¨‚ï¼Œå½±ç‰‡å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚")
            return
        except Exception as e:
            await interaction.channel.send(f"âŒ ç„¡æ³•ä¸‹è¼‰éŸ³æ¨‚: {e}")
            return

        # æ’­æ”¾éŸ³æ¨‚ä¸¦è¨­å®šæ’­æ”¾çµæŸå¾Œçš„è¡Œç‚º
        if not voice:
            channel = interaction.user.voice.channel
            voice = await channel.connect()

        try:
            voice.play(
                discord.FFmpegPCMAudio(
                    executable="C:/ffmpeg/bin/ffmpeg.exe",  # ä½¿ç”¨æ­£ç¢ºçš„ ffmpeg è·¯å¾‘
                    source="song.mp4"
                ),
                after=lambda e: self.end_song("song.mp4", interaction.guild)
            )
            await interaction.channel.send("ğŸ¶ æ­£åœ¨æ’­æ”¾éŸ³æ¨‚ã€‚")
        except Exception as e:
            await interaction.channel.send(f"âŒ æ’­æ”¾éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def download_audio(self, url):
        """ä¸‹è¼‰éŸ³æ¨‚"""
        try:
            # ä½¿ç”¨ yt_dlp æ›¿ä»£ pytube
            ydl_opts = {
                'format': 'bestaudio/best',
                'outtmpl': 'song.mp4',
                'quiet': True,
            }
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                ydl.download([url])
        except Exception as e:
            raise Exception(f"ä¸‹è¼‰å¤±æ•—: {e}")

    def end_song(self, path, guild):
        playing_list = self.get_playing_list(guild.id)

        # æ’­æ”¾å®Œå¾Œåˆªé™¤æª”æ¡ˆ
        if os.path.isfile(path):
            os.remove(path)

        # æ’­æ”¾ä¸‹ä¸€é¦–éŸ³æ¨‚
        if playing_list:
            url = playing_list.pop(0)
            voice = discord.utils.get(self.bot.voice_clients, guild=guild)

            if not voice:
                return  # å¦‚æœæ©Ÿå™¨äººå·²é›¢é–‹èªéŸ³é »é“ï¼Œå‰‡ä¸ç¹¼çºŒæ’­æ”¾

            try:
                self.download_audio(url)
                voice.play(
                    discord.FFmpegPCMAudio(executable="ffmpeg/bin/ffmpeg.exe", source="song.mp4"),
                    after=lambda e: self.end_song("song.mp4", guild)
                )
            except Exception as e:
                print(f"âŒ æ’­æ”¾ä¸‹ä¸€é¦–éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")


async def setup(bot: commands.Bot):
    await bot.add_cog(music(bot))